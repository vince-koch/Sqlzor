@page "/query"

@using System.Data;
@using System.Diagnostics;
@using Sqlzor.Data;

@inject QueryApi _queryApi;
@inject AppSettingsService _appSettings;

<h1>Query</h1>

<div class="form-group">
    <label>Connection Name</label>
    <ConnectionNameSelect @bind-ConnectionName="@connectionName" />
</div>

<div class="form-group">
    <label for="queryTextArea">Query</label>
    <QueryEditorComponent @bind-QueryText="@queryText" />
</div>

<div class="form-group">
    <button type="button" id="queryExecuteButton" class="btn btn-primary"
            disabled="@(isBusy || string.IsNullOrWhiteSpace(connectionName) || string.IsNullOrWhiteSpace(queryText))"
            @onclick="HandleExecuteQuery">
        <span class="oi oi-play-circle"></span> Execute
    </button>
</div>

<BusyComponent IsBusy="@isBusy" />
<QueryResultsComponent Error="@error" Tables="@tables" Elapsed="@elapsed" />

@code {
    private string connectionName = string.Empty;
    private string queryText = null;

    private bool isBusy = false;
    private TimeSpan? elapsed = null;
    private DataTable[] tables = null;
    private Exception error = null;

    protected override Task OnInitializedAsync()
    {
        queryText = _appSettings.InitialQueryText;
        return Task.FromResult(true);
    }

    private async Task HandleExecuteQuery()
    {
        var stopwatch = new Stopwatch();
        stopwatch.Start();

        isBusy = true;
        elapsed = null;
        tables = null;
        error = null;

        try
        {
            tables = await _queryApi.ExecuteAsync(
                connectionName,
                queryText);
        }
        catch (Exception thrown)
        {
            error = thrown;
        }
        finally
        {
            stopwatch.Stop();

            elapsed = stopwatch.Elapsed;
            isBusy = false;
        }
    }
}
